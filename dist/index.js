var index;(()=>{"use strict";var e={32:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NewcoinWriterAgent=t.NewcoinReaderAgent=void 0;const o=n(27),i=n(181),r=n(117);t.NewcoinReaderAgent=e=>{const t=(0,o.NewgraphClient)(e);return(0,i.NewcoinReader)(t)},t.NewcoinWriterAgent=e=>{const t=(0,o.NewgraphClient)(e);return(0,r.NewcoinWriter)(t)}},234:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{c(o.next(e))}catch(e){r(e)}}function s(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.NewcoinListener=void 0;const i=n(141),r=n(32);t.NewcoinListener=(e,t)=>{var n,a;const s={current:{}},c=(0,r.NewcoinWriterAgent)(e),d=c.current().then((e=>(s.current=e,e))),l=(0,i.newgraphWebsocketsClientManager)(((e,t)=>`${e}?token=${encodeURIComponent(t)}`));l.toggle(e);const u={totalStringSize:0,messagesCount:0};return null===(n=l.socket)||void 0===n||n.addEventListener("open",(()=>{d.then((()=>{console.log(`Listening as ${s.current.username}`)}))})),null===(a=l.socket)||void 0===a||a.addEventListener("message",(e=>o(void 0,void 0,void 0,(function*(){var n,o,i;const r=e.data.toString().length;if(u.totalStringSize+=r,u.messagesCount+=1,"pong"==e.data)return Promise.resolve();const a=JSON.parse(e.data.toString());if("newgraph"==a.type&&"post_in_folder"==(null===(n=null==a?void 0:a.payload)||void 0===n?void 0:n.message)){const e=((null===(i=null===(o=a.payload)||void 0===o?void 0:o.post)||void 0===i?void 0:i.content)||"").trim();if(!e.startsWith(`/${s.current.username}`))return Promise.resolve();if(t){const n=t(e.trim().replace(new RegExp(`/${s.current.username}`),""),c),o=n instanceof Promise?yield n:n;if("string"==typeof o)yield c.postMessage(a.payload.folder.id,o),console.log("replied to: ",a.payload.post.content,"in folder",a.payload.folder.id);else{const e=o.filesPaths||[void 0];for(let t=0;t<e.length;t++){const n=e[t];console.log("Uploading file",n),yield c.postMessage(a.payload.folder.id,t?"":o.content,n)}}}}})))),{get stats(){return u},wsclient:l}}},181:function(e,t){var n=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{c(o.next(e))}catch(e){r(e)}}function s(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.NewcoinReader=void 0,t.NewcoinReader=e=>{let t;return{current:()=>n(void 0,void 0,void 0,(function*(){return t||(t=yield e.authorize())})),getUser:()=>n(void 0,void 0,void 0,(function*(){return t})),toString:()=>t.username,listTopFolders:(...t)=>n(void 0,[...t],void 0,(function*(t=0){return console.log("Listing top folders..."),(yield e.api.mood.listTopList({page:t.toString()})).data})),listAttachedPosts:(t,...o)=>n(void 0,[t,...o],void 0,(function*(t,n=0,o="created"){return console.log(`Listing posts in folder ${t}...`),(yield e.api.mood.attachmentsList({id:t,page:n.toString(),order:o})).data})),listOwnFolders:()=>n(void 0,void 0,void 0,(function*(){return(yield e.api.user.moodsList()).data})),ratePost:(t,o,i)=>n(void 0,void 0,void 0,(function*(){return yield e.api.mood.rateCreate({targetId:t,contextType:"folder",contextValue:o,value:i})}))}}},117:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{c(o.next(e))}catch(e){r(e)}}function s(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.NewcoinWriter=void 0;const i=n(181),r=n(943);t.NewcoinWriter=e=>Object.assign(Object.assign({},(0,i.NewcoinReader)(e)),{toString:()=>(void 0).username,createFolder:t=>o(void 0,void 0,void 0,(function*(){return(yield e.api.mood.moodCreate({name:t+(new Date).toString()})).data})),postMessage:(t,n,i,a)=>o(void 0,void 0,void 0,(function*(){try{const o=yield e.api.post.postCreate({content:n||(new Date).toString()+" test",contentType:a});if(yield e.api.mood.attachPostUpdate({id:t,targetId:o.data.id}),i){const t=yield e.api.post.uploadCreate({targetId:o.data.id,contentType:a||"image/jpeg",filename:i.split(/\//).at(-1)}),n=yield fetch(t.data.url,{method:"PUT",body:yield(0,r.readFile)(i)});console.log("Upload status: ",n.status)}return o.data}catch(e){console.error("Failed to post response: ",e)}}))})},27:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.NewgraphClient=void 0;const o=n(278);t.NewgraphClient=e=>{const t=(0,o.NewgraphApi)();return t.initialize("https://api.newgra.ph/v1"),t.updateToken(e),t}},278:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{c(o.next(e))}catch(e){r(e)}}function s(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.NewgraphApi=t.CreatorApi=void 0;const i=n(135);class r extends i.Api{}t.CreatorApi=r,t.NewgraphApi=()=>{let e,t="";return{initialize:t=>(e=new r({baseUrl:t,securityWorker:e=>e?{headers:{Authorization:e.token}}:{}}),e),getCurrentToken:()=>t,updateToken(n){t=n,e.setSecurityData({token:n})},authorize(){return o(this,void 0,void 0,(function*(){try{return(yield e.user.currentList()).data}catch(e){throw e}}))},get api(){return e}}}},141:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{c(o.next(e))}catch(e){r(e)}}function s(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((o=o.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.newgraphWebsocketsClientManager=void 0;const r=i(n(86));t.newgraphWebsocketsClientManager=e=>{const t={socket:null},n=[];let i,a=0,s="";const c=()=>{console.log("Websockets ping failed, trying to reconnect"),s?u(s):console.log("No token, not attempting to resume after failed ping")},d=()=>{clearInterval(i)},l={open:[()=>i=setInterval((()=>{var e;if(a>0)return a--,c();try{null===(e=null==t?void 0:t.socket)||void 0===e||e.send("ping")}catch(e){return console.log("Couldn't ping:",e),c()}a++,console.log("ping, pingCounter == ",a)}),1e4),()=>{let e;for(e of n)t.send(e)},()=>console.log("Websockets client connected")],close:[d],error:[e=>console.log(e)],message:[e=>{"pong"===e.data&&(a=Math.max(a-1,0),console.log("pong, pingCounter == ",a,(new Date).toISOString()))}]},u=n=>o(void 0,void 0,void 0,(function*(){s=n;const o=e("wss://wsapi.newgra.ph/v1",n);t.url!==o&&(t.url=o,t.socket&&(Object.keys(l).forEach((e=>l[e].forEach((n=>{var o;return null===(o=t.socket)||void 0===o?void 0:o.removeEventListener(e,n)})))),t.socket.close(),t.socket=null),d(),n&&o&&(t.socket=new r.default(o),Object.keys(l).forEach((e=>l[e].forEach((n=>{var o;return null===(o=t.socket)||void 0===o?void 0:o.addEventListener(e,n)}))))))}));return t.toggle=u,t.send=e=>{var o,i,r;(null===(o=t.socket)||void 0===o?void 0:o.readyState)!=(null===(i=t.socket)||void 0===i?void 0:i.CONNECTING)?("string"!=typeof e&&(e=JSON.stringify(e)),null===(r=t.socket)||void 0===r||r.send(e)):n.push(e)},t}},135:e=>{e.exports=require("@newstackdev/iosdk-newgraph-client-js")},86:e=>{e.exports=require("ws")},943:e=>{e.exports=require("fs/promises")}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,n),r.exports}var o={};(()=>{var e=o;Object.defineProperty(e,"__esModule",{value:!0}),e.NewcoinWriterAgent=e.NewcoinReaderAgent=e.NewcoinListener=void 0;const t=n(32);Object.defineProperty(e,"NewcoinReaderAgent",{enumerable:!0,get:function(){return t.NewcoinReaderAgent}}),Object.defineProperty(e,"NewcoinWriterAgent",{enumerable:!0,get:function(){return t.NewcoinWriterAgent}});const i=n(234);Object.defineProperty(e,"NewcoinListener",{enumerable:!0,get:function(){return i.NewcoinListener}}),e.default=i.NewcoinListener})(),index=o})();